<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

	<!-- ======================================================= -->
	<!--   PRODUCT INFO                                          -->
	<!-- ======================================================= -->
	<Product
	  Id="*"
	  Name="DeviceHubMini"
	  Language="1033"
	  Version="1.0.0.0"
	  Manufacturer="YourCompany"
	  UpgradeCode="{DB8FBDAB-55ED-4C8A-832B-106965A91B9C}">

		<!-- Installer must run elevated -->
		<Package
			InstallerVersion="500"
			Compressed="yes"
			InstallScope="perMachine"
			Platform="x64"
			InstallPrivileges="elevated" />

		<MediaTemplate />
		<MajorUpgrade DowngradeErrorMessage="A newer version of DeviceHubMini is already installed." />

		<Feature Id="MainFeature" Title="DeviceHubMini Service + Tray" Level="1">
			<ComponentGroupRef Id="ServiceComponents" />
			<ComponentGroupRef Id="TrayComponents" />
		</Feature>

	</Product>

	<!-- ======================================================= -->
	<!--   INSTALL DIRECTORIES                                   -->
	<!-- ======================================================= -->
	<Fragment>
		<Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="ProgramFiles64Folder">
				<Directory Id="INSTALLFOLDER_ROOT" Name="YourCompany">
					<Directory Id="INSTALLFOLDER" Name="DeviceHubMini" />
				</Directory>
			</Directory>

			<Directory Id="ProgramMenuFolder">
				<Directory Id="AppProgramMenuDir" Name="DeviceHubMini" />
			</Directory>
		</Directory>
	</Fragment>

	<!-- ======================================================= -->
	<!--   SERVICE COMPONENT                                     -->
	<!-- ======================================================= -->
	<Fragment>
		<ComponentGroup Id="ServiceComponents">
			<Component Id="cmpServiceExe"
           Directory="INSTALLFOLDER"
           Guid="{11111111-1111-1111-1111-111111111111}"
           Win64="yes">

				<File Id="filServiceExe"
					  Source="D:\Learning\hub\DeviceHubMini\DeviceHubMini\bin\Release\net8.0-windows\win-x64\publish\DeviceHubMini.Service.exe"
					  KeyPath="yes" />

			
				<File Id="filAppSettings"
					  Source="D:\Learning\hub\DeviceHubMini\DeviceHubMini\bin\Release\net8.0-windows\win-x64\publish\appsettings.json" />

				<ServiceInstall
					Id="DeviceHubMiniService"
					Name="DeviceHubMini.Service"
					DisplayName="DeviceHubMini Service"
					Description="Scans files and sends events to the server"
					Start="auto"
					Type="ownProcess"
					Account="LocalSystem"
					ErrorControl="normal"
					Vital="yes" />

				<ServiceControl
					Id="ServiceControlInstall"
					Name="DeviceHubMini.Service"
					Start="install"
					Stop="both"
					Remove="uninstall"
					Wait="yes" />

				<ServiceControl
					Id="ServiceControlRollback"
					Name="DeviceHubMini.Service"
					Start="both"
					Stop="both"
					Remove="uninstall"
					Wait="yes"/>
			</Component>

		</ComponentGroup>
	</Fragment>


	<Fragment>
		<!-- ======================================================= -->
<!--   TRAY EXECUTABLE (Per-machine)                         -->
<!-- ======================================================= -->
<ComponentGroup Id="TrayComponents">
  <!-- EXE installation -->
  <Component Id="cmpTrayExe"
             Directory="INSTALLFOLDER"
             Guid="{22222222-2222-2222-2222-222222222222}"
             Win64="yes">

    <File Id="filTrayExe"
          Source="D:\Learning\hub\DeviceHubMini\DeviceHubMini.Tray\bin\Release\net9.0-windows\win-x64\publish\DeviceHubMini.Tray.exe"
          KeyPath="yes" />

    <!-- Optional: Auto-start (per-machine) -->
    <RegistryValue
        Root="HKLM"
        Key="Software\Microsoft\Windows\CurrentVersion\Run"
        Name="DeviceHubMiniTray"
        Value="&quot;[INSTALLFOLDER]DeviceHubMini.Tray.exe&quot;"
        Type="string" />
  </Component>

  <!-- ======================================================= -->
  <!--   SHORTCUT COMPONENT (Per-user)                         -->
  <!-- ======================================================= -->
  <Component Id="cmpTrayShortcuts"
             Directory="AppProgramMenuDir"
             Guid="{33333333-3333-3333-3333-333333333333}"
             Win64="yes">

    <!-- HKCU registry entry as KeyPath (fixes ICE43) -->
    <RegistryValue
        Root="HKCU"
        Key="Software\YourCompany\DeviceHubMini"
        Name="TrayShortcutCreated"
        Type="integer"
        Value="1"
        KeyPath="yes" />

    <!-- Start Menu Shortcut -->
    <Shortcut Id="TrayShortcut"
              Name="DeviceHubMini Tray"
              Directory="AppProgramMenuDir"
              Target="[INSTALLFOLDER]DeviceHubMini.Tray.exe"
              WorkingDirectory="INSTALLFOLDER" />

    <!-- Uninstall Shortcut -->
    <Shortcut Id="UninstallShortcut"
              Name="Uninstall DeviceHubMini"
              Directory="AppProgramMenuDir"
              Target="[System64Folder]msiexec.exe"
              Arguments="/x [ProductCode]" />

    <RemoveFolder Id="RemoveMenuDir" Directory="AppProgramMenuDir" On="uninstall" />
  </Component>
</ComponentGroup>

	</Fragment>


</Wix>
