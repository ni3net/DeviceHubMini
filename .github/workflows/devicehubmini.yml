name: DeviceHubMini CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_CLIENT: ghcr.io/${{ github.repository }}/devicehubmini-client
  IMAGE_SERVICE: ghcr.io/${{ github.repository }}/devicehubmini-service

jobs:

  # ---------------------------
  # 1. Build & Test .NET
  # ---------------------------
  build_test:
    name: Build & Test .NET Solution
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x

    - name: Restore
      run: dotnet restore DeviceHubMini.sln

    - name: Build
      run: dotnet build DeviceHubMini.sln --configuration Release --no-restore

    - name: Run Tests
      run: dotnet test DeviceHubMini.Tests/DeviceHubMini.Tests.csproj --no-build --verbosity normal


  # ---------------------------
  # 2. Build Docker Images
  # ---------------------------
  docker_build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: build_test

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build DeviceHubMini.Client Image
      run: |
        docker build -t $IMAGE_CLIENT:ci-latest ./DeviceHubMini.Client

    - name: Build DeviceHubMini.Service Image
      run: |
        docker build -t $IMAGE_SERVICE:ci-latest ./DeviceHubMini.Service

    - name: Save images for next job
      run: |
        docker save $IMAGE_CLIENT:ci-latest -o client.tar
        docker save $IMAGE_SERVICE:ci-latest -o service.tar

    - uses: actions/upload-artifact@v4
      with:
        name: docker-images
        path: |
          client.tar
          service.tar


  # ---------------------------
  # 3. Run Docker Compose & Validate
  # ---------------------------
  docker_compose_validate:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    needs: docker_build

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - uses: actions/download-artifact@v4
      with:
        name: docker-images

    - name: Load built images
      run: |
        docker load -i client.tar
        docker load -i service.tar

    - name: Install docker compose
      run: sudo apt-get update && sudo apt-get install docker-compose -y

    - name: Start Containers (docker compose)
      run: |
        docker compose up -d
        sleep 15

    - name: Validate Client is Up (GraphQL endpoint)
      run: |
        curl -f http://localhost:8080/graphql || exit 1

    - name: Validate Service Container is Running
      run: |
        docker ps
        docker logs devicehubmini-service || true

    - name: Shutdown
      if: always()
      run: docker compose down


  # ---------------------------
  # 4. Push FINAL IMAGES to GHCR
  # ---------------------------
  push_to_ghcr:
    name: Push Images to GHCR
    runs-on: ubuntu-latest
    needs: docker_compose_validate

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - uses: actions/download-artifact@v4
      with:
        name: docker-images

    - name: Load images
      run: |
        docker load -i client.tar
        docker load -i service.tar

    - name: Assign version tags
      run: |
        TAG=latest
        echo "Using tag: $TAG"
        docker tag $IMAGE_CLIENT:ci-latest $IMAGE_CLIENT:$TAG
        docker tag $IMAGE_SERVICE:ci-latest $IMAGE_SERVICE:$TAG

    - name: Push final images to GHCR
      run: |
        docker push $IMAGE_CLIENT:latest
        docker push $IMAGE_SERVICE:latest
